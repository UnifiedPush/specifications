# Specifications

UnifiedPush Spec: AND_2.0.0

## Index

* [General](#general)
* [Push Distributor](#push-distributor)
* [Connector Library](#connector-library)
* [Registration Broadcast Receiver](#registration-broadcast-receiver-1)
* [Messaging Broadcast Receiver](#messaging-broadcast-receiver-1)

## General

* All extras typed String MUST be UTF-8 encoded.
* All required extras MUST be non-null.
* End user application: This is the application that will receive notifications with UnifiedPush; All the logic required for the end user application can be done with a library.
* Connection Token: This is a randomly generated token to identify the registration from the connector and the distributor. This token is generated by the connector, and send for the first time during the registration intent (org.unifiedpush.android.distributor.REGISTER). This token must contain sufficient entropy so it cannot be guessed. To generate this token, UUIDv4 ([RFC9562]) is suggested. It is unique on distributor and connector side. Every requests to the connector contains this token. If the connector doesn't know this token, the request is ignored. This is a string of maximum 100 bytes.
* Message Id: This is an id to identify a message from the distributor to the connector. If present, the connector must acknowledge the message to the distributor (with [org.unifiedpush.android.distributor.MESSAGE_ACK]). This is a string of maximum 100 bytes. To prevent an application to acknowledge another application's message, the distributor SHOULD either:
  * Use unique token which contain sufficient entropy so it cannot be guessed; UUIDv4 ([RFC9562]) is suggested.
  * Save this id linked to the connection token, so a same id could be send to 2 different applications but one cannot acknowledge for the other.

## Push Distributor

The push distributor MUST expose the [Registration Broadcast Receiver], allowing end user applications to register for push related messages.

### Distributor manifest

The push distributor MUST expose a broadcast receiver with the following actions:
* [org.unifiedpush.android.distributor.REGISTER]
* [org.unifiedpush.android.distributor.UNREGISTER]

This broadcast receiver is the Registration Broadcast Receiver.

### Optional features

#### Sending bytes messages

The distributor MUST expose the following action if it supports sending messages as ByteArray instead of String:
* org.unifiedpush.android.distributor.feature.BYTES_MESSAGE

## End User Application

The end user application MUST expose the [Messaging Broadcast Receiver], allowing the distributor to send push related messages.

### End User Application Manifest

The library itself does not declare any activity, service or receiver in the manifest. The end user application integrating the library MUST expose a broadcast receiver with the following actions:
* [org.unifiedpush.android.connector.NEW_ENDPOINT]
* [org.unifiedpush.android.connector.UNREGISTERED]
* [org.unifiedpush.android.connector.MESSAGE]
* [org.unifiedpush.android.connector.REGISTRATION_FAILED]

This broadcast receiver is the Messaging Broadcast Receiver.

## Registration Broadcast Receiver

The exposed broadcast receiver of the push distributor MUST handle 2 different actions:
* [org.unifiedpush.android.distributor.REGISTER]
* [org.unifiedpush.android.distributor.UNREGISTER]

There is a third action the distributor SHOULD handle:
* [org.unifiedpush.android.distributor.MESSAGE_ACK]

### org.unifiedpush.android.distributor.REGISTER

The connector sends this action to register to push messages. The intent MUST contain 2 extras:
* application (String): the end user application package name. The distributor MUST be able to handle many registrations with a single application.
* token (String): This is the connection token as defined in the [Resources]. This is where a new token is used for the first time.

It MAY be sent with the following 2 extras:
* features (ArrayList\<String\>): indicate the connector is requesting a set of optional features to be enabled. It MUST be the qualified name of the action declared to advertise this feature. The connector MUST check that the action is declared before requesting an optional feature.
* message (String): a short description of the purpose of the registration that the distributor MAY show to the user.

The distributor MUST send a broadcast intent to one of the following actions when it handles this action:
* [org.unifiedpush.android.connector.NEW_ENDPOINT]
* [org.unifiedpush.android.connector.REGISTRATION_FAILED]

The distributor SHOULD NOT create a new endpoint if a valid registration exist for the token and nothing has been updated.

### org.unifiedpush.android.distributor.UNREGISTER

The connector sends this action to unregister from push messages. The intent MUST contain 1 extra:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the distributor, the distributor will ignore this request.

### org.unifiedpush.android.distributor.MESSAGE_ACK

Whenever the connector receives a message with the extra id it MUST reply with this action to the distributor to acknowledge the message's reception.

The intent MUST contain 2 extras:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the distributor, the distributor will ignore this request.
* id (String, max 100 bytes): This is the message id as defined in the [Resources].

A distributor MAY retry to send a message that has not been acknowledged.

## Messaging Broadcast Receiver

The exposed broadcast receiver of the end user application MUST handle 2 differents actions:
* [org.unifiedpush.android.connector.NEW_ENDPOINT]
* [org.unifiedpush.android.connector.MESSAGE]

There are 2 additional actions the connector SHOULD handle:
* [org.unifiedpush.android.connector.UNREGISTERED]
* [org.unifiedpush.android.connector.REGISTRATION_FAILED]

### org.unifiedpush.android.connector.NEW_ENDPOINT

The distributor MUST send this action to the registered application in the following cases:
* confirm the registration of an end user application
* a registered application sends an action with the intent [org.unifiedpush.android.distributor.REGISTER] and a token for an existing registration. The distributor MUST also update the features associated with the registration.
* the endpoint for the application changed

The intent MUST contain the following 2 extras:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the connector, the connector will ignore this request.
* endpoint (String): the endpoint URL

### org.unifiedpush.android.connector.REGISTRATION_FAILED

The distributor MUST send this action to the registered application if:
* the token is already registered for another application
* the registration can not be processed (for instance when the distributor is not connected to its server)
* a requested feature is not supported by the distributor

The action MUST contain the following extra:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the connector, the connector will ignore this request.

The intent MAY contain 1 additional extra:
* message (String): an error message describing why the registration failed

The connector MUST change the registration token received with this action for the next registration.

If a connector receives this action after it already received a NEW_ENDPOINT action for the same token then it should ignore this action.

### org.unifiedpush.android.connector.MESSAGE

The distributor MUST send this action to the registered application to forward a push message received on the push server to the end user application.

If the BYTES_MESSAGE feature was requested, it MUST send the following 2 extras:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the connector, the connector will ignore this request.
* bytesMessage (ByteArray): the push message sent by the application server, as an array of bytes. It MUST be the raw POST data received by the rewrite proxy.

If the BYTES_MESSAGE feature was requested, it MAY additionally send the message as a string:
* message (String): the push message sent by the application server, as a string.

If the BYTES_MESSAGE feature was not requested, it MUST send the following 2 extras:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the connector, the connector will ignore this request.
* message (String): the push message sent by the application server, as a string.

If the BYTES_MESSAGE feature was not requested, it MAY additionally send the message as a byte array:
* bytesMessage (ByteArray): the push message sent by the application server, as an array of bytes. It MUST be the raw POST data received by the rewrite proxy.

It MAY be sent with the following extra:
* id (String, max 100 bytes): This is the message id as defined in the [Resources]. If present, the connector MUST response with [org.unifiedpush.android.distributor.MESSAGE_ACK].


### org.unifiedpush.android.connector.UNREGISTERED

The distributor MUST send this action to the registered application to inform it about unregistration.

The intent MUST have the following extra:
* token (String): This is the connection token as defined in the [Resources] supplied by the end user application during registration. If this token is not known by the connector, the connector will ignore this request.

## References

### Internal References

[Resources]: #resources
[Registration Broadcast Receiver]: #registration-broadcast-receiver
[Messaging Broadcast Receiver]: #messaging-broadcast-receiver
[org.unifiedpush.android.distributor.REGISTER]: #orgunifiedpushandroiddistributorregister
[org.unifiedpush.android.distributor.UNREGISTER]: #orgunifiedpushandroiddistributorunregister
[org.unifiedpush.android.distributor.MESSAGE_ACK]: #orgunifiedpushandroiddistributormessageack
[org.unifiedpush.android.connector.NEW_ENDPOINT]: #orgunifiedpushandroidconnectornewendpoint
[org.unifiedpush.android.connector.REGISTRATION_FAILED]: #orgunifiedpushandroidconnectorregistrationfailed
[org.unifiedpush.android.connector.MESSAGE]: #orgunifiedpushandroidconnectormessage
[org.unifiedpush.android.connector.UNREGISTERED]: #orgunifiedpushandroidconnectorunregistered
[org.unifiedpush.android.connector.PING]: #orgunifiedpushandroidconnectorping

### Normative References

[RFC9562]: https://www.rfc-editor.org/rfc/rfc9562 "Universally Unique IDentifiers (UUIDs)"
